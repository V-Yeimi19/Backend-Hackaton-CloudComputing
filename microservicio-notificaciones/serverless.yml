service: alerta-utec-realtime
frameworkVersion: '4'

provider:
  name: aws
  runtime: python3.12
  region: us-east-1
  stage: ${opt:stage, 'dev'}

  # Usar rol existente del lab (no crear roles nuevos)
  iam:
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/LabRole

custom:
  # ðŸ‘‰ NOMBRES DE TUS TABLAS YA CREADAS
  connectionsTableName: alerta-utec-Reporte-${self:provider.stage}
  incidentesTableName: alerta-utec-Reporte-${self:provider.stage}

functions:
  websocketConnect:
    handler: websocket_connect.lambda_handler
    environment:
      CONNECTIONS_TABLE: ${self:custom.connectionsTableName}
    events:
      - websocket:
          route: $connect

  websocketDisconnect:
    handler: websocket_disconnect.lambda_handler
    environment:
      CONNECTIONS_TABLE: ${self:custom.connectionsTableName}
    events:
      - websocket:
          route: $disconnect

  dynamoStreamBroadcast:
    handler: dynamo_stream_broadcast.lambda_handler
    environment:
      CONNECTIONS_TABLE: ${self:custom.connectionsTableName}
      WS_ENDPOINT:
        Fn::Join:
          - ''
          - - 'https://'
            - Ref: WebsocketsApi
            - '.execute-api.'
            - Ref: AWS::Region
            - '.amazonaws.com/'
            - ${sls:stage}
    events:
      - stream:
          type: dynamodb
          # Se consume el ARN del stream exportado por el microservicio de reportes
          arn: ${cf:alerta-utec-reportes-${self:provider.stage}.ReporteTableStreamArn}
          maximumRetryAttempts: 3
          startingPosition: LATEST

resources:
  Resources: {}
