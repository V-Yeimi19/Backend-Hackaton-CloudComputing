service: alerta-utec-incidentes
frameworkVersion: '4'

org: ${env:SLS_ORG, 'darosv'}
app: alerta-utec

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  stage: ${env:STAGE, 'production'}

  iam:
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID, '645337731455'}:role/LabRole

  httpApi:
    cors:
      allowedOrigins:
        - '*'
      allowedMethods:
        - OPTIONS
        - GET
        - POST
        - DELETE
      allowedHeaders:
        - '*'

custom:
  # ðŸ‘‡ AHORA TODO USA LA TABLA "Incidentes"
  incidentesTableName: Incidentes
  usuariosTableName: tabla_usuarios
  tokensTableName: tokens_acceso

functions:
  crearIncidente:
    handler: crear_incidente.lambda_handler
    environment:
      INCIDENTES_TABLE: ${self:custom.incidentesTableName}
      USUARIOS_TABLE: ${self:custom.usuariosTableName}
      TOKENS_TABLE: ${self:custom.tokensTableName}
    events:
      - httpApi:
          path: /incidentes
          method: post

  eliminarIncidente:
    handler: eliminar_incidente.lambda_handler
    environment:
      INCIDENTES_TABLE: ${self:custom.incidentesTableName}
      USUARIOS_TABLE: ${self:custom.usuariosTableName}
      TOKENS_TABLE: ${self:custom.tokensTableName}
    events:
      - httpApi:
          path: /incidentes/{id}
          method: delete

  validarToken:
    handler: validar_token.lambda_handler
    environment:
      USUARIOS_TABLE: ${self:custom.usuariosTableName}
      TOKENS_TABLE: ${self:custom.tokensTableName}
    events:
      - httpApi:
          path: /validar-token
          method: post

resources:
  Resources:
    TablaIncidentes:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.incidentesTableName}   # ðŸ‘ˆ Usa "Incidentes"
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
