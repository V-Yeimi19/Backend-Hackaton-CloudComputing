org: ${env:ORG}
service: alerta-utec-reportes

provider:
  name: aws
  runtime: python3.13
  memorySize: 1024
  timeout: 20
  stage: ${opt:stage, 'dev'}
  region: us-east-1
  iam:
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/LabRole
  environment:
    INCIDENTES_TABLE: alerta-utec-Reporte-${self:provider.stage} # Renombrado para coincidir con el código
    ASIGNACIONES_TABLE: alerta-utec-AsignacionResponsables-${self:provider.stage}
    HISTORIAL_TABLE: t_historial
    TABLE_USUARIOS : alerta-utec-Usuarios-${self:provider.stage}

resources:
  Resources:
    # ============================================
    # TABLA: Reporte
    # ============================================
    # Partition Key: id (String) - UUID único del reporte
    # 
    # Atributos (se agregan dinámicamente al insertar items):
    # - UsuarioId (String): ID del usuario que creó el reporte
    # - DescripcionCorta (String): Descripción breve del incidente
    # - Categoria (String): Categoría del incidente
    #   * Limpieza y desorden
    #   * Fugas
    #   * Calidad del inmobiliario
    #   * Calidad de lo servicios (Luz, Internet, Agua)
    #   * Aulas cerradas
    #   * Objeto perdido
    # - Gravedad (String): Nivel de urgencia (debil, moderado, fuerte)
    # - Lugar (String): Ubicación del incidente
    # - estado (String): Estado del reporte (PENDIENTE, EN ARREGLO, SOLUCIONADO)
    # - createdAt (String): Timestamp ISO de creación
    # - updatedAt (String): Timestamp ISO de última actualización
    # ============================================
    ReporteTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.INCIDENTES_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          - Key: Project
            Value: AlertaUTEC
          - Key: Microservicio
            Value: reportes

    # ============================================
    # TABLA: AsignacionResponsables
    # ============================================
    # Partition Key: ReporteId (String) - ID del reporte
    #
    # Atributos (se agregan dinámicamente al insertar items):
    # - TrabajadoresId (List): Lista de IDs de trabajadores asignados
    # ============================================
    AsignacionResponsablesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ASIGNACIONES_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: ReporteId
            AttributeType: S
        KeySchema:
          - AttributeName: ReporteId
            KeyType: HASH
        Tags:
          - Key: Project
            Value: AlertaUTEC
          - Key: Microservicio
            Value: reportes
  Outputs:
    ReporteTableStreamArn:
      Description: "The ARN for the Reporte DynamoDB table stream"
      Value:
        Fn::GetAtt: [ ReporteTable, StreamArn ]
      Export:
        Name: ${self:service}-${self:provider.stage}-ReporteTableStreamArn

functions:
  # ========== REPORTES - CRUD ==========
  crearReporte:
    handler: reportes/crearReporte.lambda_handler
    events:
      - http:
          path: /reportes
          method: post
          cors: true
          integration: lambda-proxy

  obtenerReporte:
    handler: reportes/obtenerReporte.lambda_handler
    events:
      - http:
          path: /reportes/{id}
          method: get
          cors: true
          integration: lambda-proxy

  listarReportes:
    handler: reportes/listarReportes.lambda_handler
    events:
      - http:
          path: /reportes
          method: get
          cors: true
          integration: lambda-proxy

  eliminarReporte:
    handler: reportes/eliminarReporte.lambda_handler
    events:
      - http:
          path: /reportes/{id}
          method: delete
          cors: true
          integration: lambda-proxy

  actualizarEstadoIncidente:
    handler: reportes/update_incidente.lambda_handler
    events:
      - http:
          path: /reportes/{id}/estado
          method: put
          cors: true
          integration: lambda-proxy

  obtenerHistorial:
    handler: reportes/Lambda_ObtenerHistorial.lambda_handler
    events:
      - http:
          path: /reportes/{id}/historial
          method: get
          cors: true
          integration: lambda-proxy

  historialStream:
    handler: reportes/historial_stream.lambda_handler
    events:
      - stream:
          type: dynamodb
          arn:
            Fn::GetAtt: [ ReporteTable, StreamArn ]
          startingPosition: LATEST
          maximumRetryAttempts: 3

  # ========== ASIGNACIONES ==========
  asignarResponsables:
    handler: reportes/Lambda_GestionTrabajadores.lambda_handler
    events:
      - http:
          path: /reportes/{id}/asignar
          method: post
          cors: true
          integration: lambda-proxy

  obtenerResponsables:
    handler: reportes/obtenerResponsables.lambda_handler
    events:
      - http:
          path: /reportes/{id}/responsables
          method: get
          cors: true
          integration: lambda-proxy
